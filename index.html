<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 äº’åŠ¨è´ºå¡</title>
    
    <style>
        :root {
            --primary: #FF5E5E;
            --secondary: #FFD93D;
            --bg: #FFF9F0;
            --text: #4A4A4A;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, "PingFang SC", sans-serif; }
        
        /* é…ç½®é¢æ¿ - å¡é€šé£æ ¼ */
        #configPanel {
            position: absolute; z-index: 200; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text); transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s;
        }

        h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 5px; text-shadow: 2px 2px 0px #fff; }
        .subtitle { font-size: 0.9rem; color: #999; margin-bottom: 30px; }

        .upload-container { width: 85%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; }

        .upload-card {
            background: #fff; padding: 20px; border-radius: 24px;
            text-align: center; border: 4px solid #F0F0F0;
            box-shadow: 0 8px 0px #F0F0F0;
            display: flex; flex-direction: column; align-items: center;
        }

        .upload-card p { margin: 0 0 10px 0; font-weight: bold; font-size: 1rem; }

        .upload-btn {
            display: inline-block; padding: 12px 24px; 
            background: var(--secondary); color: #845D00;
            border-radius: 16px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            transition: transform 0.1s;
        }
        .upload-btn:active { transform: scale(0.95); }

        .preview-box { width: 80px; height: 80px; margin-top: 15px; border-radius: 18px; display: none; object-fit: cover; border: 3px solid var(--secondary); }

        #startBtn { 
            margin-top: 40px; padding: 18px 60px; 
            background: linear-gradient(135deg, #FF7E7E, #FF5E5E);
            color: white; border: none; border-radius: 25px; 
            font-size: 1.3rem; font-weight: bold;
            box-shadow: 0 10px 0px #D64545;
            transition: all 0.1s;
        }
        #startBtn:active { transform: translateY(5px); box-shadow: 0 5px 0px #D64545; }

        /* æ¸¸æˆä¸»ä½“æ ·å¼ä¿æŒä¸€è‡´ */
        .bg-img { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        #imgB { z-index: 5; opacity: 0; transform: scale(0.6); transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #imgB.active { opacity: 1; transform: scale(1); }
        
        #fogCanvas { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; filter: blur(12px); opacity: 0; transition: opacity 1.5s ease; pointer-events: none; }
        #fogCanvas.active { pointer-events: auto; }

        #instruction { 
            position: absolute; bottom: 12%; left: 50%; transform: translateX(-50%); 
            color: white; z-index: 11; text-align: center; pointer-events: none; 
            background: rgba(255, 94, 94, 0.9); padding: 15px 30px; border-radius: 30px; 
            box-shadow: 0 6px 0px #D64545; display: none; width: 70%; font-weight: bold;
        }

        .shake { animation: shake 0.12s 4; }
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-8px, 8px); } 75% { transform: translate(8px, -8px); } }
    </style>
</head>
<body>

<div id="container">
    <div id="configPanel">
        <h2>âœ¨ äº’åŠ¨è´ºå¡åˆ¶ä½œ</h2>
        <p class="subtitle">ç»™å¥½å‹ä¸€ä¸ªæƒŠå–œå§</p>
        
        <div class="upload-container">
            <div class="upload-card">
                <p>ğŸ“¸ ç¬¬ä¸€æ­¥ï¼šå°é¢å›¾</p>
                <label class="upload-btn"><input type="file" id="inputA" accept="image/*" style="display:none;">é€‰æ‹©æœ¬åœ°å›¾ç‰‡</label>
                <img id="prevA" class="preview-box">
            </div>

            <div class="upload-card">
                <p>ğŸ ç¬¬äºŒæ­¥ï¼šæƒŠå–œå›¾</p>
                <label class="upload-btn"><input type="file" id="inputB" accept="image/*" style="display:none;">é€‰æ‹©æœ¬åœ°å›¾ç‰‡</label>
                <img id="prevB" class="preview-box">
            </div>
        </div>

        <button id="startBtn">å¼€å§‹äº’åŠ¨</button>
    </div>

    <img id="imgA" class="bg-img">
    <img id="imgB" class="bg-img">
    <canvas id="fogCanvas"></canvas>
    <div id="instruction">ğŸ’¨ è¯·å¯¹ç€éº¦å…‹é£<br>ç”¨åŠ›å“ˆä¸€å£æ°”...</div>

    <audio id="bgMusic" src="110.WAV" loop preload="auto"></audio>
    <audio id="successSound" src="å›¾ç‰‡å‡ºç°å£°.mp3" preload="auto"></audio>
</div>

<script>
    const configPanel = document.getElementById('configPanel');
    const imgA = document.getElementById('imgA');
    const imgB = document.getElementById('imgB');
    const startBtn = document.getElementById('startBtn');
    const canvas = document.getElementById('fogCanvas');
    const ctx = canvas.getContext('2d');
    const instruction = document.getElementById('instruction');
    const bgMusic = document.getElementById('bgMusic');
    const successSound = document.getElementById('successSound');

    let isFoggy = false;
    let isFinished = false;
    let breathEnergy = 0;

    function setupUpload(inputEl, targetImg, prevEl) {
        inputEl.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                targetImg.src = url;
                prevEl.src = url;
                prevEl.style.display = 'block';
            }
        };
    }
    setupUpload(document.getElementById('inputA'), imgA, document.getElementById('prevA'));
    setupUpload(document.getElementById('inputB'), imgB, document.getElementById('prevB'));

    function initCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = 'rgba(235, 245, 255, 0.98)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    startBtn.onclick = async () => {
        if (!imgA.src || !imgB.src) return alert("è¦ä¸Šä¼ ä¸¤å¼ å›¾æ‰èƒ½å¼€å§‹å“¦ï¼");
        bgMusic.play().catch(() => {});
        successSound.load();

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            configPanel.style.transform = 'translateY(-100%)';
            configPanel.style.opacity = '0';
            setTimeout(() => configPanel.style.display = 'none', 600);
            instruction.style.display = 'block';
            initCanvas();

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 512;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function listen() {
                if (isFoggy) return;
                analyser.getByteFrequencyData(dataArray);
                let lowFreqSum = 0;
                for (let i = 0; i < 10; i++) lowFreqSum += dataArray[i];
                let average = lowFreqSum / 10;

                // å¼ºåŒ–é˜²è¯¯è§¦åˆ¤å®š
                if (average > 120) { 
                    breathEnergy += 10;
                } else {
                    breathEnergy = Math.max(0, breathEnergy - 3);
                }

                if (breathEnergy > 100) {
                    activateFog();
                } else {
                    requestAnimationFrame(listen);
                }
            }
            listen();
        } catch (err) {
            alert("è¯·æˆäºˆéº¦å…‹é£æƒé™ï¼Œå¦åˆ™æ— æ³•ç©è€å“ˆæ°”æ•ˆæœå“¦ï¼");
        }
    };

    function activateFog() {
        isFoggy = true;
        canvas.classList.add('active');
        canvas.style.opacity = '1';
        instruction.innerHTML = "âœ¨ é•œé¢èµ·é›¾å•¦<br>å¿«æ“¦äº®å®ƒï¼";
        setTimeout(() => { instruction.style.opacity = '0'; }, 3000);
    }

    function handleDraw(e) {
        if (!isFoggy || isFinished) return;
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 70, 0, Math.PI * 2);
        ctx.fill();
        checkProgress();
    }

    function checkProgress() {
        if (isFinished) return;
        const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let clear = 0;
        for (let i = 3; i < pixels.length; i += 4) if (pixels[i] < 150) clear++;
        if (clear / (pixels.length / 4) > 0.45) {
            isFinished = true;
            setTimeout(() => {
                bgMusic.pause();
                successSound.play(); 
                document.getElementById('container').classList.add('shake');
                canvas.style.opacity = '0';
                imgB.classList.add('active');
            }, 800);
        }
    }

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleDraw(e); }, { passive: false });
</script>

</body>
</html>
