<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 äº’åŠ¨è´ºå¡</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: -apple-system, sans-serif; }
        #container { position: relative; width: 100%; height: 100%; }
        #configPanel {
            position: absolute; z-index: 200; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.6s ease;
        }
        .upload-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;
            margin: 10px; width: 75%; text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .upload-btn { display: inline-block; padding: 10px 20px; background: #444; border-radius: 10px; margin-top: 8px; cursor: pointer; font-size: 0.85rem; }
        .preview-box { width: 50px; height: 50px; margin: 8px auto 0; border-radius: 8px; display: none; object-fit: cover; border: 2px solid #ff4d4d; }
        #startBtn { 
            margin-top: 25px; padding: 15px 50px; background: linear-gradient(135deg, #ff4d4d, #b30000);
            color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold;
        }
        .bg-img { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        #imgB { z-index: 5; opacity: 0; transform: scale(0.6); transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #imgB.active { opacity: 1; transform: scale(1); }
        #fogCanvas { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; filter: blur(12px); opacity: 0; transition: opacity 1.2s ease; pointer-events: none; }
        #fogCanvas.active { pointer-events: auto; }
        #instruction { 
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); 
            color: white; z-index: 11; text-align: center; pointer-events: none; 
            background: rgba(0,0,0,0.6); padding: 12px 20px; border-radius: 25px; 
            backdrop-filter: blur(10px); display: none; font-size: 0.9rem;
        }
        .shake { animation: shake 0.12s 4; }
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-8px, 8px); } 75% { transform: translate(8px, -8px); } }
    </style>
</head>
<body>

<div id="container">
    <div id="configPanel">
        <h2 style="margin-bottom: 5px;">2026 äº’åŠ¨è´ºå¡</h2>
        <div class="upload-card">
            <p style="margin: 0;">1. è®¾ç½®å°é¢å›¾ç‰‡</p>
            <label class="upload-btn"><input type="file" id="inputA" accept="image/*" style="display:none;">é€‰æ‹©å›¾ç‰‡</label>
            <img id="prevA" class="preview-box">
        </div>
        <div class="upload-card">
            <p style="margin: 0;">2. è®¾ç½®æƒŠå–œå›¾ç‰‡</p>
            <label class="upload-btn"><input type="file" id="inputB" accept="image/*" style="display:none;">é€‰æ‹©å›¾ç‰‡</label>
            <img id="prevB" class="preview-box">
        </div>
        <button id="startBtn">åˆ¶ä½œå®Œæˆ</button>
    </div>

    <img id="imgA" class="bg-img">
    <img id="imgB" class="bg-img">
    <canvas id="fogCanvas"></canvas>
    <div id="instruction">ğŸ’¨ è¯·å¯¹ç€éº¦å…‹é£<br><b>ç”¨åŠ›å‘µæ°”</b></div>

    <audio id="bgMusic" src="110.WAV" loop preload="auto"></audio>
    <audio id="successSound" src="å›¾ç‰‡å‡ºç°å£°.mp3" preload="auto"></audio>
</div>

<script>
    const configPanel = document.getElementById('configPanel');
    const imgA = document.getElementById('imgA');
    const imgB = document.getElementById('imgB');
    const startBtn = document.getElementById('startBtn');
    const canvas = document.getElementById('fogCanvas');
    const ctx = canvas.getContext('2d');
    const instruction = document.getElementById('instruction');
    const bgMusic = document.getElementById('bgMusic');
    const successSound = document.getElementById('successSound');

    let isFoggy = false;
    let isFinished = false;
    let breathEnergy = 0;

    // å›¾ç‰‡é€‰æ‹©é€»è¾‘
    function setupUpload(inputID, imgID, prevID) {
        document.getElementById(inputID).onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                document.getElementById(imgID).src = url;
                document.getElementById(prevID).src = url;
                document.getElementById(prevID).style.display = 'block';
            }
        };
    }
    setupUpload('inputA', 'imgA', 'prevA');
    setupUpload('inputB', 'imgB', 'prevB');

    function initCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = 'rgba(230, 240, 255, 0.98)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    startBtn.onclick = async () => {
        if (!imgA.src || !imgB.src) return alert("è¯·å…ˆä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼");
        
        bgMusic.play().catch(() => {});
        successSound.load();

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            configPanel.style.opacity = '0';
            setTimeout(() => { configPanel.style.display = 'none'; }, 600);
            instruction.style.display = 'block';
            initCanvas();

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function listen() {
                if (isFoggy) return;
                analyser.getByteFrequencyData(dataArray);
                
                // èšç„¦æä½é¢‘
                let lowFreq = (dataArray[0] + dataArray[1] + dataArray[2]) / 3;

                // åªæœ‰å½“å£°éŸ³éå¸¸å“äº®ï¼ˆå“ˆæ°”ï¼‰æ—¶æ‰å¢é•¿ï¼Œå¦åˆ™å¿«é€Ÿæ¶ˆé€€
                if (lowFreq > 125) { 
                    breathEnergy += 8; 
                } else {
                    breathEnergy -= 5;
                }
                
                breathEnergy = Math.max(0, breathEnergy);

                if (breathEnergy > 120) {
                    activateFog();
                } else {
                    requestAnimationFrame(listen);
                }
            }
            listen();
        } catch (err) {
            alert("è¯·æˆäºˆéº¦å…‹é£æƒé™ï¼å¦‚æœæ˜¯æœ¬åœ°é¢„è§ˆï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ã€‚");
        }
    };

    function activateFog() {
        isFoggy = true;
        canvas.classList.add('active');
        canvas.style.opacity = '1';
        instruction.innerHTML = "âœ¨ é•œé¢å·²èµ·é›¾<br>æ‰‹æŒ‡æ“¦äº®æƒŠå–œ";
        setTimeout(() => { instruction.style.opacity = '0'; }, 3000);
    }

    function handleDraw(e) {
        if (!isFoggy || isFinished) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 60, 0, Math.PI * 2);
        ctx.fill();
        checkProgress();
    }

    function checkProgress() {
        if (isFinished) return;
        const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let clear = 0;
        for (let i = 3; i < pixels.length; i += 4) { if (pixels[i] < 150) clear++; }
        
        if (clear / (pixels.length / 4) > 0.4) {
            isFinished = true;
            setTimeout(() => {
                bgMusic.pause();
                successSound.play();
                document.getElementById('container').classList.add('shake');
                canvas.style.opacity = '0';
                imgB.classList.add('active');
            }, 800);
        }
    }

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleDraw(e); }, { passive: false });
    window.onresize = initCanvas;
</script>
</body>
</html>
