<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 äº’åŠ¨è´ºå¡</title>
    <style>
        :root { --primary: #FF5E5E; --secondary: #FFD93D; --bg: #FFF9F0; --text: #4A4A4A; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: -apple-system, "PingFang SC", sans-serif; }
        #container { position: relative; width: 100%; height: 100%; }

        /* é…ç½®é¢æ¿ */
        #configPanel {
            position: absolute; z-index: 200; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.5s ease;
        }
        .upload-card { background: #fff; padding: 15px; border-radius: 20px; margin: 10px; width: 80%; max-width: 300px; text-align: center; border: 4px solid #F0F0F0; box-shadow: 0 6px 0px #F0F0F0; }
        .upload-btn { display: inline-block; padding: 10px 20px; background: var(--secondary); color: #845D00; border-radius: 12px; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
        .preview-box { width: 60px; height: 60px; margin-top: 10px; border-radius: 10px; display: none; object-fit: cover; border: 2px solid var(--secondary); margin-inline: auto; }
        #startBtn { margin-top: 30px; padding: 15px 50px; background: linear-gradient(135deg, #FF7E7E, #FF5E5E); color: white; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 8px 0px #D64545; }

        /* äº’åŠ¨å±‚ */
        .bg-img { position: absolute; width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        #imgB { z-index: 5; opacity: 0; transform: scale(0.8); transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #imgB.active { opacity: 1; transform: scale(1); }
        #fogCanvas { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; filter: blur(12px); opacity: 0; transition: opacity 1s; pointer-events: none; }
        #fogCanvas.active { pointer-events: auto; }

        #instruction { 
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); 
            color: white; z-index: 11; text-align: center; pointer-events: none; 
            background: rgba(255, 94, 94, 0.9); padding: 15px 25px; border-radius: 30px; 
            box-shadow: 0 6px 0px #D64545; display: none; width: 60%; font-weight: bold;
        }
        #breathBar { position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); width: 40%; height: 4px; background: rgba(0,0,0,0.1); z-index: 12; display: none; border-radius: 2px; overflow: hidden; }
        #breathFill { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; }
        
        .shake { animation: shake 0.12s 4; }
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-8px, 8px); } 75% { transform: translate(8px, -8px); } }
    </style>
</head>
<body>

<div id="container">
    <div id="configPanel">
        <h2>âœ¨ äº’åŠ¨è´ºå¡åˆ¶ä½œ</h2>
        <div class="upload-card">
            <p>ğŸ“¸ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å°é¢å›¾</p>
            <label class="upload-btn"><input type="file" id="inputA" accept="image/*" style="display:none;">é€‰æ‹©å›¾ç‰‡</label>
            <img id="prevA" class="preview-box">
        </div>
        <div class="upload-card">
            <p>ğŸ ç¬¬äºŒæ­¥ï¼šä¸Šä¼ æƒŠå–œå›¾</p>
            <label class="upload-btn"><input type="file" id="inputB" accept="image/*" style="display:none;">é€‰æ‹©å›¾ç‰‡</label>
            <img id="prevB" class="preview-box">
        </div>
        <button id="startBtn">åˆ¶ä½œå®Œæˆ</button>
    </div>

    <img id="imgA" class="bg-img">
    <img id="imgB" class="bg-img">
    <canvas id="fogCanvas"></canvas>
    
    <div id="instruction">ğŸ’¨ è¯·å¯¹ç€åº•éƒ¨éº¦å…‹é£<br>ç”¨åŠ›å‘µæ°”...</div>
    <div id="breathBar"><div id="breathFill"></div></div>

    <audio id="bgMusic" src="110.WAV" loop preload="auto"></audio>
    <audio id="successSound" src="å›¾ç‰‡å‡ºç°å£°.mp3" preload="auto"></audio>
</div>

<script>
    const imgA = document.getElementById('imgA');
    const imgB = document.getElementById('imgB');
    const startBtn = document.getElementById('startBtn');
    const canvas = document.getElementById('fogCanvas');
    const ctx = canvas.getContext('2d');
    const instruction = document.getElementById('instruction');
    const breathBar = document.getElementById('breathBar');
    const breathFill = document.getElementById('breathFill');
    const bgMusic = document.getElementById('bgMusic');
    const successSound = document.getElementById('successSound');

    let isFoggy = false;
    let isFinished = false;
    let breathEnergy = 0;

    // å›¾ç‰‡ä¸Šä¼ 
    function setupUpload(inputID, imgID, prevID) {
        document.getElementById(inputID).onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                document.getElementById(imgID).src = url;
                document.getElementById(prevID).src = url;
                document.getElementById(prevID).style.display = 'block';
            }
        };
    }
    setupUpload('inputA', 'imgA', 'prevA');
    setupUpload('inputB', 'imgB', 'prevB');

    startBtn.onclick = async () => {
        if (!imgA.src || !imgB.src) return alert("è¯·å…ˆä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼");
        
        // --- æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»ç¬é—´è§£é”æ‰€æœ‰éŸ³é¢‘æƒé™ ---
        bgMusic.play().catch(() => {});
        successSound.play().then(() => {
            successSound.pause(); 
            successSound.currentTime = 0;
        }).catch(() => {});

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            document.getElementById('configPanel').style.display = 'none';
            instruction.style.display = 'block';
            breathBar.style.display = 'block';
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.fillStyle = 'rgba(235, 245, 255, 0.98)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function listen() {
                if (isFoggy) return;
                analyser.getByteFrequencyData(dataArray);
                
                // ä»…æŠ“å–æä½é¢‘ (0-3) çš„èƒ½é‡ï¼Œé¿å¼€ç¯å¢ƒå™ªéŸ³
                let lowFreq = (dataArray[0] + dataArray[1] + dataArray[2]) / 3;

                // --- ç»ˆæé˜²è¯¯è§¦é€»è¾‘ ---
                if (lowFreq > 175) { // é˜ˆå€¼æå‡åˆ°175ï¼Œéœ€æœ‰åŠ›å‘µæ°”
                    breathEnergy += 12; 
                } else {
                    breathEnergy -= 10; // åªè¦å£°éŸ³ç¨å°ï¼Œèƒ½é‡è¿…é€Ÿå´©å¡Œ
                }

                breathEnergy = Math.max(0, Math.min(120, breathEnergy));
                breathFill.style.width = (breathEnergy / 120 * 100) + '%';

                if (breathEnergy >= 120) {
                    isFoggy = true;
                    canvas.classList.add('active');
                    canvas.style.opacity = '1';
                    instruction.innerHTML = "âœ¨ é•œé¢å·²èµ·é›¾<br>æ‰‹æŒ‡æ“¦äº®å±å¹•";
                    breathBar.style.display = 'none';
                    setTimeout(() => instruction.style.opacity = '0', 3000);
                } else {
                    requestAnimationFrame(listen);
                }
            }
            listen();
        } catch (err) { alert("éœ€æˆæƒéº¦å…‹é£æƒé™æ–¹å¯äº’åŠ¨ï¼"); }
    };

    function handleDraw(e) {
        if (!isFoggy || isFinished) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 60, 0, Math.PI * 2);
        ctx.fill();
        
        // è¿›åº¦æ£€æµ‹
        const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let clear = 0;
        for (let i = 3; i < pixels.length; i += 4) { if (pixels[i] < 150) clear++; }
        
        if (clear / (pixels.length / 4) > 0.4) {
            isFinished = true;
            canvas.style.opacity = '0';
            imgB.classList.add('active');
            
            // åœæ­¢BGMå¹¶æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            bgMusic.pause();
            successSound.play();
            
            document.getElementById('container').classList.add('shake');
        }
    }
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleDraw(e); }, { passive: false });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleDraw(e); }, { passive: false });
</script>
</body>
</html>
